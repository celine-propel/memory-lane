{% extends "base.html" %}
{% block content %}
<div class="flex flex-col items-center justify-center py-10 text-center">
  <div id="game-ui" class="w-full max-w-2xl">
    <div class="text-[10px] font-black text-indigo-400 mb-4 uppercase tracking-widest">
      Verbal Fluency · <span id="time-left">30</span>s left
    </div>

    <h2 class="text-3xl sm:text-4xl font-black text-white mb-8">
      Name as many <span id="category-label" class="text-indigo-200">—</span>
    </h2>

    <div class="mb-6">
      <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Last Heard</div>
      <div id="subtitle"
           class="text-4xl sm:text-5xl font-black uppercase tracking-wide text-slate-400">
        Waiting…
      </div>
      <div id="subtitle-note" class="text-xs text-indigo-200/60 mt-2">
        Speak clearly. Say one item at a time.
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
      <div class="rounded-2xl bg-white/5 border border-white/10 p-5">
        <div class="text-[10px] font-black uppercase tracking-[0.2em] text-indigo-200/70">Counted</div>
        <div id="counted" class="text-5xl font-black text-white mt-2">0</div>
        <div class="text-xs text-slate-300/70 mt-2">Unique items in category.</div>
      </div>

      <div class="rounded-2xl bg-white/5 border border-white/10 p-5 text-left">
        <div class="text-[10px] font-black uppercase tracking-[0.2em] text-indigo-200/70 mb-2">Accepted Items</div>
        <div id="accepted-list" class="text-sm text-white/90 space-y-1 max-h-36 overflow-auto"></div>
        <div class="text-xs text-slate-300/60 mt-2">Duplicates don’t count.</div>
      </div>
    </div>

    <div id="mic-status" class="flex items-center gap-3 justify-center text-[10px] font-black uppercase tracking-[0.2em] text-slate-500">
      <div class="w-3 h-3 rounded-full bg-rose-500 animate-pulse" id="status-indicator"></div>
      <span id="status-text">Waiting for Mic...</span>
    </div>

    <div class="mt-6 flex justify-center gap-3">
      <button id="start-btn" type="button"
        class="px-5 py-2.5 rounded-xl bg-indigo-500 text-white text-sm font-bold hover:bg-indigo-400 transition shadow-md">
        Start
      </button>
      <button id="stop-btn" type="button" disabled
        class="px-5 py-2.5 rounded-xl bg-white/10 text-white text-sm font-bold hover:bg-white/20 transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
        Submit
      </button>
    </div>
  </div>

  <div id="score-display" class="hidden text-white font-black">SAVING SIGNAL...</div>
</div>

<script>
(() => {
  // ===== Config =====
  const DURATION_S = 30;

  // Updated to Category-only rotation
  const PROMPTS = [
    { category: "animals", domain: "Language" },
    { category: "fruits", domain: "Language" },
    { category: "countries", domain: "Language" },
    { category: "foods", domain: "Language" },
    { category: "sports", domain: "Language" }
  ];

  const STOPWORDS = new Set(["a","an","the","and","or","of","to","for","like"]);

  // ===== DOM =====
  const timeLeftEl = document.getElementById("time-left");
  const categoryEl = document.getElementById("category-label");
  const subtitleEl = document.getElementById("subtitle");
  const countedEl = document.getElementById("counted");
  const acceptedListEl = document.getElementById("accepted-list");

  const startBtn = document.getElementById("start-btn");
  const stopBtn = document.getElementById("stop-btn");

  const statusIndicator = document.getElementById("status-indicator");
  const statusText = document.getElementById("status-text");

  const gameUI = document.getElementById("game-ui");
  const scoreDisplay = document.getElementById("score-display");

  // ===== State =====
  let prompt = null;
  let running = false;
  let timerId = null;
  let endAt = 0;

  const accepted = new Set();
  const acceptedRaw = [];

  let totalUtterances = 0;
  let rejectedUtterances = 0;
  let duplicates = 0;

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null;

  // ===== Helpers =====

  let availablePrompts = [];

  function pickPrompt() {
    // If empty, refill and shuffle the pool
    if (availablePrompts.length === 0) {
      availablePrompts = [...PROMPTS].sort(() => Math.random() - 0.5);
    }
    // Pull one category out
    return availablePrompts.pop();
  }
  function setSubtitle(text, ok) {
    subtitleEl.textContent = text || "—";
    subtitleEl.className =
      "text-4xl sm:text-5xl font-black uppercase tracking-wide " +
      (ok === true ? "text-emerald-300" : ok === false ? "text-rose-300" : "text-slate-400");
  }

  function addAccepted(word) {
    accepted.add(word);
    acceptedRaw.unshift(word);
    acceptedListEl.innerHTML = acceptedRaw.slice(0, 24).map(w =>
      `<div class="px-2 py-1 rounded-lg bg-white/5 border border-white/10">${w}</div>`
    ).join("");
    countedEl.textContent = String(accepted.size);
  }

  function normalizeToken(t) {
    return t
      .toLowerCase()
      .replace(/[^a-z]/g, "")
      .trim();
  }

  function extractCandidate(transcript) {
    const tokens = transcript.split(/\s+/).map(normalizeToken).filter(Boolean);
    for (const tok of tokens) {
      if (!STOPWORDS.has(tok)) return tok;
    }
    return "";
  }

  function updateTimer() {
    const now = Date.now();
    const remainingMs = Math.max(0, endAt - now);
    const remainingS = Math.ceil(remainingMs / 1000);
    timeLeftEl.textContent = String(remainingS);

    if (remainingMs <= 0) finishGame();
  }

  function setMicStatus(listening) {
    if (listening) {
      statusIndicator.classList.remove("bg-rose-500", "animate-pulse");
      statusIndicator.classList.add("bg-emerald-500");
      statusText.textContent = "Listening";
    } else {
      statusIndicator.classList.remove("bg-emerald-500");
      statusIndicator.classList.add("bg-rose-500", "animate-pulse");
      statusText.textContent = "Mic stopped";
    }
  }

  async function finishGame() {
    if (!running) return;
    running = false;

    if (timerId) clearInterval(timerId);
    timerId = null;

    stopBtn.disabled = true;
    startBtn.disabled = true;

    try { if (recognition) recognition.stop(); } catch (e) {}

    gameUI.classList.add("hidden");
    scoreDisplay.classList.remove("hidden");
    scoreDisplay.textContent = "SAVING SIGNAL...";

    // 1. Calculate percentage based on 12-word benchmark
    const rawCount = accepted.size;
    const scorePercentage = Math.min(Math.round((rawCount / 12) * 100), 100);

    // 2. Prepare detailed behavioral data for the "ML Challenge"
    const scoreDetails = {
      raw_word_count: rawCount,
      target_met: rawCount >= 12,
      bonus_words: Math.max(0, rawCount - 12),
      category: prompt.category,
      duration_s: DURATION_S
    };

    await fetch("/api/score", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        game: "verbal_fluency",
        domain: "Language",
        value: scorePercentage, // Dashboard shows 0-100%
        details: scoreDetails,   // AI uses raw data for analytics
        accepted_items: acceptedRaw
      })
    });

    window.location.href = "/dashboard";
  }

  function startGame() {
    if (running) return;

    // Resetting state before starting mic
    prompt = pickPrompt();
    categoryEl.textContent = prompt.category.toUpperCase();

    accepted.clear();
    acceptedRaw.length = 0;
    acceptedListEl.innerHTML = "";
    countedEl.textContent = "0";
    totalUtterances = 0;
    rejectedUtterances = 0;
    duplicates = 0;

    setSubtitle("Initializing mic...", null);

    running = true;
    startBtn.disabled = true;
    stopBtn.disabled = false;

    endAt = Date.now() + DURATION_S * 1000;
    updateTimer();
    timerId = setInterval(updateTimer, 150);

    if (!SpeechRecognition) {
      setSubtitle("Speech not supported", false);
      setMicStatus(false);
      return;
    }

    // Creating fresh recognition instance to fix the bug
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = false; 
    recognition.lang = "en-US";

    recognition.onstart = () => {
      setMicStatus(true);
      setSubtitle("Speak now…", null);
    };

    recognition.onresult = (event) => {
      if (!running) return;

      const lastIndex = event.results.length - 1;
      let transcript = event.results[lastIndex][0].transcript.trim().toLowerCase();
      if (!transcript) return;

      const candidate = extractCandidate(transcript);
      if (!candidate) return;

      totalUtterances += 1;

      if (accepted.has(candidate)) {
        duplicates += 1;
        setSubtitle(candidate + " (duplicate)", false);
        return;
      }

      setSubtitle(candidate, true);
      addAccepted(candidate);
    };

    recognition.onerror = (e) => {
      console.error("Mic error:", e);
      setMicStatus(false);
      setSubtitle("Mic error: " + e.error, false);
    };

    recognition.onend = () => {
      if (running) {
        try { recognition.start(); } catch (e) {}
      } else {
        setMicStatus(false);
      }
    };

    try { 
      recognition.start(); 
    } catch (e) {
      console.error("Start failed:", e);
      setMicStatus(false);
      setSubtitle("Mic failed to start", false);
    }
  }

  startBtn.addEventListener("click", startGame);
  stopBtn.addEventListener("click", finishGame);
})();
</script>
{% endblock %}